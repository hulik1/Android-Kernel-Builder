
name: GKI Kernel CI
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (thin)
        uses: actions/checkout@v4

      - name: Install repo (needed for AOSP)
        run: |
          sudo apt-get update
          sudo apt-get install -y git python-is-python3 curl
          curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Repo init + sync (kernel manifest)
        run: |
          mkdir gki && cd gki
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10-2025-05
          repo sync -c --no-tags --no-clone-bundle -j2

      - name: Add KernelSU
        run: |
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          
      - name: Build kernel (legacy build script)
        run: |
          cd gki
          export BUILD_CONFIG=common/build.config.gki.aarch64
          build/build.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gki-artifacts
          path: gki/out/**/*
